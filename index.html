<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculadora de Derivadas</title>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }
        .container {
            max-width: 800px;
            background: white;
            margin: 2rem;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        label {
            font-weight: 600;
            display: block;
            margin: 1rem 0 0.5rem;
        }
        input[type="text"] {
            width: 100%;
            height: 2.5rem;
            font-size: 1.1rem;
            padding: 0 0.5rem;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            font-size: 1.1rem;
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        .output-section {
            margin-top: 2rem;
        }
        .explanation {
            background: #eef4ff;
            border-left: 6px solid #007bff;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: Consolas, monospace;
        }
        #plot {
            margin-top: 2rem;
            height: 400px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Calculadora de Derivadas</h1>
    <label for="functionInput">Función (en variable x):</label>
    <input type="text" id="functionInput" placeholder="Ejemplo: x^3 + 2*x^2 + x" />
    <button onclick="calcularDerivada()">Calcular derivada y graficar</button>

    <div class="output-section">
        <h3>Derivada paso a paso (forma larga):</h3>
        <div id="longStep" class="explanation"></div>
        
        <h3>Derivada forma corta:</h3>
        <div id="shortStep" class="explanation"></div>

        <h3>Gráfica de la función y su derivada:</h3>
        <div id="plot"></div>
    </div>
</div>

<script>
    // Función para derivar usando Math.js (simplificada, sin mostrar todos los pasos simbólicamente)
    function derivarFuncion(expr) {
        const x = math.symbolicUtils.symbol('x');
        // math.derivative solo acepta cadena y variable
        return math.derivative(expr, 'x').toString();
    }

    // Función para crear explicación detallada paso a paso (ejemplo con patrón simple)
    function crearExplicacionLarga(funcion) {
        // Esta función muestra un ejemplo general, en la práctica podría ampliarse para casos más complejos.
        let pasos = "";
        pasos += `Función original: f(x) = ${funcion}\n\n`;
        pasos += "Paso 1: Identifique cada término y aplique la regla de derivación:\n";
        // Trata de separar términos multiplicados y aplicar potencia
        const terminos = funcion.match(/([+-]?\s*\d*\.?\d*)?\*?x(\^\d+)?|([+-]?\s*\d+\.?\d*)/g);
        if (!terminos) {
            pasos += "No se pudieron identificar términos correctamente para una explicación detallada.\n";
            return pasos;
        }
        terminos.forEach((t, i) => {
            if (t.includes('x')) {
                let coeficiente = 1;
                let exponente = 1;
                let match = t.match(/([+-]?\s*\d*\.?\d*)?\*?x(\^(\d+))?/);
                if (match) {
                    coeficiente = match[1] ? parseFloat(match[1].replace(/\s+/g, '')) : 1;
                    if (isNaN(coeficiente)) coeficiente = match[1].includes('-') ? -1 : 1;
                    exponente = match[3] ? parseInt(match[3]) : 1;
                }
                pasos += `- Para el término "${t.trim()}": aplique la regla de potencia:\n`;
                pasos += `  Derivada = ${coeficiente} * ${exponente} * x^(${exponente - 1}) = ${coeficiente * exponente}x^${exponente - 1}\n\n`;
            } else {
                pasos += `- Para el término constante "${t.trim()}": la derivada es 0\n\n`;
            }
        });
        pasos += "Paso 2: Sumar las derivadas de cada término para obtener la derivada total.";
        return pasos;
    }

    // Función para limpiar expresiones y prepararlas para math.js
    function cleanExpr(expr) {
        return expr.replace(/\^/g, '**').replace(/\s+/g, '');
    }

    // Función para graficar con Plotly
    function graficar(funcion, derivada) {
        const xVals = [];
        const yFunc = [];
        const yDer = [];
        for(let i = -10; i <= 10; i += 0.1) {
            xVals.push(i);
            try {
                yFunc.push(math.evaluate(funcion, {x:i}));
            } catch {
                yFunc.push(null);
            }
            try {
                yDer.push(math.evaluate(derivada, {x:i}));
            } catch {
                yDer.push(null);
            }
        }
        const traceFunc = {
            x: xVals,
            y: yFunc,
            type: 'scatter',
            mode: 'lines',
            name: 'Función f(x)',
            line: {color: 'blue'}
        };
        const traceDer = {
            x: xVals,
            y: yDer,
            type: 'scatter',
            mode: 'lines',
            name: 'Derivada f\'(x)',
            line: {color: 'red'}
        };
        const layout = {
            title: 'Gráfica de la función y su derivada',
            xaxis: {title: 'x'},
            yaxis: {title: 'y'},
            legend: {x: 0, y: 1}
        };
        Plotly.newPlot('plot', [traceFunc, traceDer], layout, {responsive:true});
    }

    function calcularDerivada() {
        const funcionRaw = document.getElementById('functionInput').value.trim();
        if (!funcionRaw) {
            alert('Por favor ingrese una función.');
            return;
        }
        const funcion = cleanExpr(funcionRaw);
        let derivada;
        try {
            derivada = derivarFuncion(funcion);
        } catch {
            alert('Error al calcular la derivada. Revisa la función ingresada.');
            return;
        }

        // Mostrar pasos
        document.getElementById('longStep').textContent = crearExplicacionLarga(funcionRaw);
        document.getElementById('shortStep').textContent = `f'(x) = ${derivada.replace(/\*\*/g, '^')}`;

        // Graficar
        graficar(funcion, derivada);
        
        // Actualizar MathJax para fórmulas si alguna fórmula compleja aparece (opcional)
        MathJax.typesetPromise();
    }
</script>
</body>
</html>
