<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calculadora de Derivadas</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.9.0/math.js"></script>
    <style>
        /* Estilos originales sin modificaciones */
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; background-color: #f0f2f5; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 15px; }
        input[type="text"] { width: 70%; padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #grafico { margin-top: 20px; height: 400px; }
        .resultado { background-color: #f8f9fa; padding: 15px; margin-top: 15px; border-radius: 4px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <!-- Interfaz original sin cambios -->
    <div class="container">
        <h2>Calculadora de Derivadas</h2>
        <div class="input-group">
            <input type="text" id="funcion" placeholder="Ingresa la función (ej: x^2, sin(x))">
            <button onclick="calcularDerivada()">Calcular</button>
            <button onclick="limpiarPantalla()">Limpiar</button>
        </div>
        
        <h3>Resultado Simple:</h3>
        <div class="resultado" id="resultadoSimple"></div>
        
        <h3>Explicación Detallada:</h3>
        <div class="resultado" id="explicacionLarga"></div>
        
        <h3>Gráfico de la Función y su Derivada:</h3>
        <div id="grafico"></div>
    </div>

    <script>
    // Versión corregida manteniendo estructura original
    function cleanExpr(expr) {
        return expr.replace(/ /g, '')
            .replace(/sen/g, 'sin')
            .replace(/²/g, '^2').replace(/³/g, '^3')
            .replace(/(\d+)([a-zA-Z])/g, '$1*$2')
            .replace(/([a-zA-Z])(\d+)/g, '$1*$2')
            .replace(/([a-zA-Z])(\()/g, '$1*$2');
    }

    function derivarFuncion(funcion) {
        try {
            const expr = math.parse(cleanExpr(funcion));
            return math.simplify(math.derivative(expr, 'x')).toString();
        } catch (e) {
            return "Error: Verifique la sintaxis de la función";
        }
    }

    function crearExplicacionCorta(funcion) {
        const derivada = derivarFuncion(funcion);
        return derivada.includes("Error") ? derivada : `Método directo:\nf'(x) = ${derivada}`;
    }

    function crearExplicacionLarga(funcion) {
        let pasos = "";
        try {
            const expr = cleanExpr(funcion);
            if(!/^[0-9xX\+\-\*\/\^\(\)\.sincostanlgexp]+$/.test(expr)) {
                throw new Error("Caracteres no permitidos detectados");
            }

            const f_x = math.parse(expr);
            const f_xh = f_x.transform(node => {
                if (node.isSymbolNode && node.name === 'x') {
                    return math.parse('(x + h)');
                }
                return node;
            });

            // Desarrollo del límite formal
            pasos += `Paso 1 – Definición formal:\nf'(x) = limₕ→₀ [f(x+h) - f(x)] / h\n`;
            pasos += `Sustituyendo f(x) = ${funcion}:\n${math.parse(expr.replace(/x/g, '(x+h)')).toString()} - ${funcion}\n\n`;
            
            const numerador = math.simplify(math.subtract(f_xh, f_x));
            pasos += `Paso 2 – Desarrollo algebraico:\n${numerador.toString().replace(/\*\*/g, '^')}\n\n`;
            
            const paso3 = math.simplify(math.divide(numerador, 'h'));
            pasos += `Paso 3 – División por h:\n${paso3.toString().replace(/\*\*/g, '^')}\n\n`;
            
            const limite = math.simplify(paso3.replace(/h/g, '0'));
            pasos += `Paso 4 – Aplicación del límite:\n${limite.toString().replace(/\*\*/g, '^')}\n\n`;
            pasos += `Resultado final:\nf'(x) = ${limite}`;

        } catch (e) {
            pasos = `Error en el cálculo: ${e.message}`;
        }
        return pasos;
    }

    function graficarFuncion(funcion) {
        try {
            const xValues = Array.from({length: 100}, (_, i) => (i - 50) * 0.1);
            const yOriginal = xValues.map(x => math.evaluate(funcion, {x}));
            const derivada = derivarFuncion(funcion);
            
            if(derivada.includes("Error")) throw new Error(derivada);
            
            const yDerivada = xValues.map(x => math.evaluate(derivada, {x}));

            Plotly.newPlot('grafico', [
                {x: xValues, y: yOriginal, name: 'Función original'},
                {x: xValues, y: yDerivada, name: 'Derivada'}
            ], {margin: {t: 30}});
        } catch (e) {
            document.getElementById('grafico').innerHTML = `<div class="error">${e.message}</div>`;
        }
    }

    function calcularDerivada() {
        const funcion = document.getElementById('funcion').value;
        document.getElementById('resultadoSimple').textContent = crearExplicacionCorta(funcion);
        document.getElementById('explicacionLarga').textContent = crearExplicacionLarga(funcion);
        graficarFuncion(funcion);
    }

    function limpiarPantalla() {
        document.getElementById('funcion').value = '';
        document.getElementById('resultadoSimple').textContent = '';
        document.getElementById('explicacionLarga').textContent = '';
        Plotly.purge('grafico');
    }
    </script>
</body>
</html>
