<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculadora de Derivadas con Explicaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-xl shadow-xl p-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-blue-200 pb-4">Calculadora Profesional de Derivadas</h1>
            
            <div class="grid gap-6 mb-8">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Función matemática:</label>
                        <input type="text" id="funcion" 
                               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Ej: 3x^2 + cos(2x) - e^x">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Variable de derivación:</label>
                        <input type="text" id="variable" value="x" 
                               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap gap-4 mb-8">
                <button onclick="calcularDerivada('formal')" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                    </svg>
                    Método Formal
                </button>
                <button onclick="calcularDerivada('directa')" 
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg transition-colors flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Método Directo
                </button>
            </div>

            <div id="resultados" class="space-y-6">
                <!-- Sección Método Formal -->
                <div id="pasos-formales" class="hidden bg-gray-50 p-6 rounded-xl">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                        <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2">1</span>
                        Proceso Formal por Límites
                    </h3>
                    <div id="pasos-contenido" class="text-gray-700 space-y-4">
                        <div class="paso">
                            <p class="text-sm font-medium text-blue-600">Paso 1: Definición formal</p>
                            <p id="sustitucion" class="mt-1"></p>
                        </div>
                        <div class="paso">
                            <p class="text-sm font-medium text-blue-600">Paso 2 y 3: Desarrollo y simplificación</p>
                            <p id="simplificacion" class="mt-1"></p>
                        </div>
                        <div class="paso">
                            <p class="text-sm font-medium text-blue-600">Paso 4: Aplicación del límite</p>
                            <p id="limite-final" class="mt-1"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Sección Método Directo -->
                <div id="resultado-directo" class="hidden bg-gray-50 p-6 rounded-xl">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                        <span class="bg-emerald-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2">2</span>
                        Método de Reglas de Derivación
                    </h3>
                    <div id="pasos-directos" class="text-gray-700 space-y-4">
                        <div class="paso">
                            <p class="text-sm font-medium text-emerald-600">Paso 1: Identificar componentes</p>
                            <p id="componentes" class="mt-1"></p>
                        </div>
                        <div class="paso">
                            <p class="text-sm font-medium text-emerald-600">Paso 2: Aplicar reglas de derivación</p>
                            <p id="reglas-aplicadas" class="mt-1"></p>
                        </div>
                        <div class="paso">
                            <p class="text-sm font-medium text-emerald-600">Paso 3: Simplificar expresión</p>
                            <p id="simplificacion-directa" class="mt-1"></p>
                        </div>
                    </div>
                </div>

                <!-- Contenedor para gráfica -->
                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Gráfica de función y derivada</h3>
                    <canvas id="grafica" width="700" height="400" class="border rounded-lg"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        function calcularDerivada(tipo) {
            try {
                const funcionRaw = document.getElementById('funcion').value.trim();
                const variable = document.getElementById('variable').value.trim() || 'x';
                const funcion = funcionRaw.replace(/\s+/g, '');

                document.getElementById('pasos-formales').classList.add('hidden');
                document.getElementById('resultado-directo').classList.add('hidden');

                if (tipo === 'formal') {
                    document.getElementById('pasos-formales').classList.remove('hidden');

                    // Paso 1: Definición formal
                    document.getElementById('sustitucion').innerHTML = `
                        \\[
                        f'(x) = \\lim_{h \\to 0} \\frac{f(${variable}+h) - f(${variable})}{h}
                        \\]
                        \\[
                        f'(x) = \\lim_{h \\to 0} \\frac{${funcion.replace(new RegExp(variable, 'g'), `${variable}+h`)} - ${funcion}}{h}
                        \\]
                    `;

                    // Intentar derivar paso a paso para potencias simples ax^n
                    const pasosFormales = generarPasosFormalesPotencia(funcion, variable);
                    if (pasosFormales) {
                        document.getElementById('simplificacion').innerHTML = pasosFormales.desarrollo;
                        document.getElementById('limite-final').innerHTML = pasosFormales.limite;
                    } else {
                        document.getElementById('simplificacion').innerHTML = 'Desarrollo paso a paso disponible solo para potencias simples de la forma \\(a x^{n}\\).';
                        const derivadaDirecta = math.derivative(funcionRaw, variable).toString();
                        document.getElementById('limite-final').innerHTML = `
                          \\[
                          \\text{Derivada aproximada: } ${derivadaDirecta}
                          \\]
                        `;
                    }
                } else {
                    // Método directo con explicación de reglas
                    const derivada = math.derivative(funcionRaw, variable);
                    const steps = [];

                    derivada.traverse(node => {
                        if (node.isOperatorNode && node.op === '^') {
                            steps.push(`Aplicando regla de la potencia: \\[ \\frac{d}{d${variable}}${node.toString()} = ${node.args[1]} ${node.args[0].toString()}^{${node.args[1]-1}} \\]`);
                        }
                        if (node.isFunctionNode) {
                            steps.push(`Aplicando regla para ${node.name}: \\[ \\frac{d}{d${variable}}${node.toString()} = ${math.derivative(node.toString(), variable).toString()} \\]`);
                        }
                    });

                    document.getElementById('resultado-directo').classList.remove('hidden');
                    document.getElementById('componentes').innerHTML = `Función descompuesta: \\[ ${math.parse(funcionRaw).toString()} \\]`;
                    document.getElementById('reglas-aplicadas').innerHTML = steps.join('<br>') || 'No se identificaron reglas específicas.';
                    document.getElementById('simplificacion-directa').innerHTML = `\\[ \\frac{d}{d${variable}}(${funcionRaw}) = ${derivada.toString()} \\]`;
                }

                graficarFuncionYDerivada(funcionRaw, variable);

                MathJax.typeset();
            } catch (error) {
                alert(`Error: ${error.toString().replace('Error: ', '')}`);
            }
        }

        // Helper para generar pasos formales para potencias simples ax^n
        function generarPasosFormalesPotencia(funcion, variable) {
            // Intentar extraer coeficiente y exponente de la forma ax^n
            const regex = /^([\d\.]*)\*?x\^(\d+)$/i;
            const match = funcion.match(regex);
            if (!match) return null;

            let a = match[1] === '' ? 1 : parseFloat(match[1]);
            const n = parseInt(match[2], 10);

            // Construir desarrollo paso a paso en LaTeX
            const desarrollo = `
                \\[
                (${variable} + h)^${n} = \\sum_{k=0}^{${n}} \\binom{${n}}{k} ${variable}^{${n}-k} h^{k}
                \\]
                \\[
                = ${variable}^${n} + ${n}${variable}^{${n - 1}}h + \\ldots + h^{${n}}
                \\]
                \\[
                \\frac{${a}(${variable} + h)^${n} - ${a}${variable}^${n}}{h} = 
                \\frac{${a}${variable}^${n} + ${a}${n}${variable}^{${n - 1}}h + \\ldots + ${a}h^{${n}} - ${a}${variable}^${n}}{h}
                \\]
                \\[
                = \\frac{${a}${n}${variable}^{${n - 1}}h + \\ldots + ${a}h^{${n}}}{h} =
                ${a}${n}${variable}^{${n - 1}} + \\ldots + ${a}h^{${n - 1}}
                \\]
            `;

            const limite = `
                \\[
                \\lim_{h \\to 0} \\left(${a}${n}${variable}^{${n - 1}} + \\ldots + ${a}h^{${n - 1}}\\right) = ${a}${n}${variable}^{${n - 1}}
                \\]
            `;

            return { desarrollo, limite };
        }

        function graficarFuncionYDerivada(funcionStr, variableStr) {
            const canvas = document.getElementById('grafica');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const margen = 50;
            const anchoGraf = canvas.width - 2 * margen;
            const altoGraf = canvas.height - 2 * margen;

            const xMin = -10;
            const xMax = 10;
            const pasos = 0.1;

            let f, derivada;
            try {
                f = math.compile(funcionStr);
                derivada = math.derivative(funcionStr, variableStr).compile();
            } catch {
                return;
            }

            const xs = [];
            const ysFunc = [];
            const ysDer = [];
            for(let x = xMin; x <= xMax; x += pasos) {
                xs.push(x);
                try {
                    ysFunc.push(f.evaluate({[variableStr]: x}));
                } catch {
                    ysFunc.push(null);
                }
                try {
                    ysDer.push(derivada.evaluate({[variableStr]: x}));
                } catch {
                    ysDer.push(null);
                }
            }

            let valoresY = ysFunc.concat(ysDer).filter(v => v !== null && isFinite(v));
            let yMin = Math.min(...valoresY);
            let yMax = Math.max(...valoresY);

            if (yMin === yMax) {
                yMin -= 1;
                yMax += 1;
            }

            function aX(x) {
                return margen + ((x - xMin) / (xMax - xMin)) * anchoGraf;
            }
            function aY(y) {
                return margen + altoGraf - ((y - yMin) / (yMax - yMin)) * altoGraf;
            }

            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;

            ctx.beginPath();
            ctx.moveTo(margen, aY(0));
            ctx.lineTo(margen + anchoGraf, aY(0));
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(aX(0), margen);
            ctx.lineTo(aX(0), margen + altoGraf);
            ctx.stroke();

            ctx.strokeStyle = 'blue';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < xs.length; i++) {
                const xPix = aX(xs[i]);
                const yVal = ysFunc[i];
                if (yVal === null || !isFinite(yVal)) {
                    ctx.moveTo(xPix, aY(0));
                } else {
                    const yPix = aY(yVal);
                    if (i === 0) ctx.moveTo(xPix, yPix);
                    else ctx.lineTo(xPix, yPix);
                }
            }
            ctx.stroke();

            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < xs.length; i++) {
                const xPix = aX(xs[i]);
                const yVal = ysDer[i];
                if (yVal === null || !isFinite(yVal)) {
                    ctx.moveTo(xPix, aY(0));
                } else {
                    const yPix = aY(yVal);
                    if (i === 0) ctx.moveTo(xPix, yPix);
                    else ctx.lineTo(xPix, yPix);
                }
            }
            ctx.stroke();

            ctx.fillStyle = 'blue';
            ctx.fillRect(margen + 10, margen + 10, 20, 10);
            ctx.fillStyle = 'black';
            ctx.fillText('f(x)', margen + 35, margen + 20);
            ctx.fillStyle = 'red';
            ctx.fillRect(margen + 10, margen + 30, 20, 10);
            ctx.fillStyle = 'black';
            ctx.fillText('f\'(x)', margen + 35, margen + 40);

            ctx.fillStyle = 'black';
            ctx.font = '12px Arial';
            ctx.fillText('0', aX(0) - 10, aY(0) + 15);
            ctx.fillText(xMin, margen, aY(0) + 15);
            ctx.fillText(xMax, margen + anchoGraf - 15, aY(0) + 15);
            ctx.fillText(yMin.toFixed(2), aX(0) + 5, margen + altoGraf);
            ctx.fillText(yMax.toFixed(2), aX(0) + 5, margen + 12);
        }
    </script>
</body>
</html>
