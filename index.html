<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Mantener mismo head y estilos -->
</head>
<body>
    <!-- Interfaz sin cambios -->
    
    <script>
    // FUNCIÓN CORREGIDA: crearExplicacionLarga
    function crearExplicacionLarga(funcion) {
        let pasos = "";
        try {
            const expr = cleanExpr(funcion);
            
            // Validación mejorada
            if(!/^[0-9xX\+\-\*\/\^\(\)\.sincostanlogexpln]+$/.test(expr)) {
                throw new Error("Caracteres no permitidos");
            }
            
            const f = math.parse(expr);
            const variables = f.filter(node => node.isSymbolNode && node.name !== 'x');
            if(variables.length > 0) {
                throw new Error("Solo se permite la variable 'x'");
            }

            // Paso 1: Construcción del límite
            pasos += `[1] Definición formal:\nf'(x) = limₕ→₀ [f(x+h) - f(x)] / h\n`;
            const f_xh = math.parse(expr.replace(/x/g, '(x+h)'));
            pasos += `Sustitución:\n${f_xh.toString()} - ${f.toString()}\n\n`;

            // Paso 2: Desarrollo algebraico
            const numerador = math.simplify(math.subtract(f_xh, f));
            pasos += `[2] Simplificación del numerador:\n${numerador.toString()}\n\n`;

            // Paso 3: División por h
            if(!numerador.toString().includes('h')) {
                throw new Error("No se detectó cambio con h - revise la función");
            }
            const paso3 = math.simplify(math.divide(numerador, 'h'));
            pasos += `[3] División por h:\n${paso3.toString()}\n\n`;

            // Paso 4: Aplicación del límite
            const limite = math.simplify(paso3.replace(/h/g, 0));
            pasos += `[4] Límite cuando h→0:\n${limite.toString()}\n\n`;
            pasos += `✅ Derivada final:\nf'(x) = ${limite}`;

        } catch (e) {
            pasos = `❌ Error en el cálculo:\n${e.message}\n\nRecomendaciones:\n`
                   + `• Use solo 'x' como variable\n`
                   + `• Verifique paréntesis balanceados\n`
                   + `• Use notación matemática estándar`;
        }
        return pasos;
    }

    // Resto de funciones igual al código anterior...
    </script>
</body>
</html>
