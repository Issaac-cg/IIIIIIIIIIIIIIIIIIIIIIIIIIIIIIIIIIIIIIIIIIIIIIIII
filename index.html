<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculadora Profesional de Derivadas - Con Método Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">

<div class="max-w-4xl mx-auto p-6">
    <div class="bg-white rounded-xl shadow-xl p-8 mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-blue-200 pb-4">Calculadora Profesional de Derivadas</h1>
        
        <div class="grid gap-6 mb-8">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Función matemática:</label>
                    <input type="text" id="funcion" 
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Ej: 3x^2 + cos(2x) - e^x" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Variable de derivación:</label>
                    <input type="text" id="variable" value="x" 
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                </div>
            </div>
        </div>

        <div class="flex flex-wrap gap-4 mb-8">
            <button onclick="calcularDerivada('formal')" 
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                </svg>
                Método Formal
            </button>
            <button onclick="calcularDerivada('directa')" 
                class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg transition-colors flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                Método Directo
            </button>
            <button onclick="calcularDerivada('completo')" 
                class="bg-indigo-700 hover:bg-indigo-800 text-white px-6 py-3 rounded-lg transition-colors flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Método Completo Paso a Paso
            </button>
        </div>

        <div id="resultados" class="space-y-8">

            <!-- Método Formal -->
            <div id="pasos-formales" class="hidden bg-gray-50 p-6 rounded-xl">
                <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                    <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2">1</span>
                    Proceso Formal por Límites (Evaluación Numérica)
                </h3>
                <div class="text-gray-700 space-y-4">
                    <div>
                        <p class="text-sm font-medium text-blue-600">Paso 1: Definición formal</p>
                        <p class="mt-1">\[ f'(x) = \lim_{h \to 0} \frac{f(x + h) - f(x)}{h} \]</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-blue-600">Paso 2: Sustitución en la función</p>
                        <p id="sustitucion" class="mt-1"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-blue-600">Paso 3: Simplificación algebraica evaluada</p>
                        <p id="simplificacion" class="mt-1"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-blue-600">Paso 4: Aplicación del límite</p>
                        <p id="limite-final" class="mt-1"></p>
                    </div>
                </div>
            </div>
            
            <!-- Método Directo -->
            <div id="resultado-directo" class="hidden bg-gray-50 p-6 rounded-xl">
                <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                    <span class="bg-emerald-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2">2</span>
                    Método de Reglas de Derivación (Simbólico)
                </h3>
                <div class="text-gray-700 space-y-4">
                    <div>
                        <p class="text-sm font-medium text-emerald-600">Paso 1: Identificar componentes</p>
                        <p id="componentes" class="mt-1"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-emerald-600">Paso 2: Aplicar reglas de derivación</p>
                        <p id="reglas-aplicadas" class="mt-1"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-emerald-600">Paso 3: Simplificar expresión</p>
                        <p id="simplificacion-directa" class="mt-1"></p>
                    </div>
                </div>
            </div>

            <!-- Método Completo -->
            <div id="resultado-completo" class="hidden bg-gray-50 p-6 rounded-xl">
                <h3 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                    <span class="bg-indigo-700 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2">3</span>
                    Método Completo Tradicional Paso a Paso
                </h3>
                <div class="text-gray-700 space-y-6" id="metodo-completo-contenido">
                    <!-- Contenido generado dinámicamente -->
                </div>
            </div>

            <!-- Contenedor para gráfica -->
            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Gráfica de función y derivada</h3>
                <canvas id="grafica" width="700" height="400" class="border rounded-lg"></canvas>
            </div>

        </div>
    </div>
</div>

<script>
    // Función para simplificar expresión con math.js y devolver cadena legible (usada para muestra)
    function simplificarExpr(exprStr) {
        try {
            const exprNode = math.parse(exprStr);
            const simplified = exprNode.simplify();
            return simplified.toString();
        } catch {
            return exprStr;
        }
    }

    // Función para sustituir variable x por (x + h) en la función con math.js
    function sustituirXporXmasH(funcionStr, variable) {
        try {
            const nodo = math.parse(funcionStr);
            const nodoXMasH = nodo.transform(function (node, path, parent) {
                if (node.isSymbolNode && node.name === variable) {
                    return new math.expression.node.OperatorNode('+', 'add', [
                        new math.expression.node.SymbolNode(variable),
                        new math.expression.node.SymbolNode('h')
                    ]);
                }
                return node;
            });
            return nodoXMasH.toString();
        } catch {
            return null;
        }
    }

    // Función para generar el método completo paso a paso usando el método de los 4 pasos
    function metodoCompletoPasoAPaso(funcionStr, variable) {
        // Paso 1: Evaluar f(x+h)
        const f_xmash = sustituirXporXmasH(funcionStr, variable);
        if (!f_xmash) return "Error en el análisis de la función para f(x+h).";

        // Paso 2: Diferencia f(x+h) - f(x)
        const diferencia = `(${f_xmash}) - (${funcionStr})`;

        // Paso 3: Cociente \frac{f(x+h)-f(x)}{h}
        const cociente = `((${diferencia})/h)`;

        // Paso 4: Simplificar límite cuando h -> 0:
        // Para simplificar este cociente, reemplazamos 'h' como símbolo y simplificamos
        let exprSimplificadaStr;
        let derivadaFinalStr;
        try {
            // Crear expresión matemática
            const exprCociente = math.parse(cociente);

            // Simplificar el cociente antes de tomar límite
            const exprSimplificada = exprCociente.simplify();

            exprSimplificadaStr = exprSimplificada.toString();

            // Derivada final: es el límite cuando h->0, esto equivale a derivar con math.js como validación
            derivadaFinalStr = math.derivative(funcionStr, variable).toString();

        } catch {
            exprSimplificadaStr = cociente; // queda sin simplificar
            derivadaFinalStr = "No se pudo calcular derivada final";
        }

        // Usamos MathJax LaTeX para mostrar todos los pasos formalmente
        const contenidoHTML = `
        <div>
            <p><strong>Paso 1:</strong> Evaluar la función en \( ${variable} + h \):</p>
            <p class="pl-4 mt-1 mb-3">\\[ f(${variable} + h) = ${f_xmash.replace(/\*/g, '')} \\]</p>
        </div>
        <div>
            <p><strong>Paso 2:</strong> Calcular la diferencia \( f(${variable}+h) - f(${variable}) \):</p>
            <p class="pl-4 mt-1 mb-3">\\[ ${diferencia.replace(/\*/g, '')} \\]</p>
        </div>
        <div>
            <p><strong>Paso 3:</strong> Dividir entre \( h \) para formar el cociente incremental:</p>
            <p class="pl-4 mt-1 mb-3">\\[ \\frac{f(${variable}+h) - f(${variable})}{h} = ${exprSimplificadaStr.replace(/\*/g, '')} \\]</p>
        </div>
        <div>
            <p><strong>Paso 4:</strong> Tomar el límite cuando \( h \to 0 \):</p>
            <p class="pl-4 mt-1 mb-3">\\[ \lim_{h \\to 0} ${exprSimplificadaStr.replace(/\*/g, '')} = ${derivadaFinalStr.replace(/\*/g, '')} \\]</p>
        </div>`;

        return contenidoHTML;
    }

    function calcularDerivada(tipo) {
        try {
            const funcion = document.getElementById('funcion').value.trim();
            const variable = document.getElementById('variable').value.trim();

            if (!funcion) {
                alert("Por favor ingresa una función.");
                return;
            }
            if (!variable) {
                alert("Por favor ingresa la variable de derivación.");
                return;
            }

            // Ocultar todas las secciones al iniciar
            document.getElementById('pasos-formales').classList.add('hidden');
            document.getElementById('resultado-directo').classList.add('hidden');
            document.getElementById('resultado-completo').classList.add('hidden');

            if (tipo === 'formal') {
                // Método Formal: se evalúa en puntos numéricos para ilustrar límite
                const parser = math.parse(funcion);
                const f = parser.compile();
                const h = 0.00001;
                const val = 0; // evaluar en x=0 solo como ejemplo

                let f_x, f_xh;
                try {
                    f_x = f.evaluate({[variable]: val});
                    f_xh = f.evaluate({[variable]: val + h});
                } catch {
                    alert("Error evaluando la función en valores numéricos.");
                    return;
                }

                document.getElementById('pasos-formales').classList.remove('hidden');
                document.getElementById('sustitucion').innerHTML = `\\[ f(${variable} + h) = ${funcion.replace(new RegExp(variable, 'g'), `${variable} + h`)} \\]`;
                document.getElementById('simplificacion').innerHTML = `\\[ \\frac{${f_xh.toFixed(6)} - ${f_x.toFixed(6)}}{h} \\]`;
                const derivSimbolica = math.derivative(funcion, variable).toString();
                const limiteVal = ((f_xh - f_x) / h).toFixed(6);
                document.getElementById('limite-final').innerHTML = `\\[ \\lim_{h \\to 0} \\frac{${f_xh.toFixed(6)} - ${f_x.toFixed(6)}}{h} = ${limiteVal} \\approx ${derivSimbolica.replace(/\*/g, '')} \\]`;

            } else if (tipo === 'directa') {
                // Método Directo: reglas simbólicas y explicación
                const derivada = math.derivative(funcion, variable);
                const pasos = [];

                derivada.traverse(node => {
                    if(node.isOperatorNode && node.op === '^') {
                        pasos.push(`Aplicando regla de la potencia: \\[ \\frac{d}{d${variable}} ${node.toString()} = ${node.args[1]} \\cdot ${node.args[0]}^{${node.args[1].value - 1}} \\]`);
                    }
                    if(node.isFunctionNode) {
                        pasos.push(`Aplicando regla para función \\( ${node.name} \\): \\[ \\frac{d}{d${variable}} ${node.toString()} = ${math.derivative(node.toString(), variable).toString()} \\]`);
                    }
                });

                document.getElementById('resultado-directo').classList.remove('hidden');
                document.getElementById('componentes').innerHTML = `Función descompuesta: \\[ ${funcion.replace(/\*/g, '')} \\]`;
                document.getElementById('reglas-aplicadas').innerHTML = pasos.length ? pasos.join('<div class="my-2"></div>') : 'No se identificaron reglas específicas.';
                document.getElementById('simplificacion-directa').innerHTML = `\\[ \\frac{d}{d${variable}}(${funcion.replace(/\*/g, '')}) = ${derivada.toString().replace(/\*/g, '')} \\]`;

            } else if (tipo === 'completo') {
                // Método Completo: usar método de los cuatro pasos
                const contenido = metodoCompletoPasoAPaso(funcion, variable);
                document.getElementById('resultado-completo').classList.remove('hidden');
                document.getElementById('metodo-completo-contenido').innerHTML = contenido;
            }

            // Siempre graficar la función y su derivada
            graficarFuncionYDerivada(funcion, variable);

            MathJax.typesetPromise();
        } catch (error) {
            alert("Error: " + error.toString());
        }
    }

    // Función para graficar en canvas sin librerías externas
    function graficarFuncionYDerivada(funcionStr, variableStr) {
        const canvas = document.getElementById('grafica');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const margen = 50;
        const anchoGraf = canvas.width - 2 * margen;
        const altoGraf = canvas.height - 2 * margen;

        const xMin = -10;
        const xMax = 10;
        const pasos = 0.1;

        let f, derivada;
        try {
            f = math.compile(funcionStr);
            derivada = math.derivative(funcionStr, variableStr).compile();
        } catch {
            return;
        }

        const xs = [];
        const ysFunc = [];
        const ysDer = [];
        for(let x = xMin; x <= xMax; x += pasos) {
            xs.push(x);
            try {
                ysFunc.push(f.evaluate({[variableStr]: x}));
            } catch {
                ysFunc.push(null);
            }
            try {
                ysDer.push(derivada.evaluate({[variableStr]: x}));
            } catch {
                ysDer.push(null);
            }
        }

        const valoresY = ysFunc.concat(ysDer).filter(v => v !== null && isFinite(v));
        let yMin = Math.min(...valoresY);
        let yMax = Math.max(...valoresY);
        if (yMin === yMax) {
            yMin -= 1;
            yMax += 1;
        }

        function aX(x) {
            return margen + ((x - xMin) / (xMax - xMin)) * anchoGraf;
        }
        function aY(y) {
            return margen + altoGraf - ((y - yMin) / (yMax - yMin)) * altoGraf;
        }

        // Dibujar ejes
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;

        // Eje X
        ctx.beginPath();
        ctx.moveTo(margen, aY(0));
        ctx.lineTo(margen + anchoGraf, aY(0));
        ctx.stroke();

        // Eje Y
        ctx.beginPath();
        ctx.moveTo(aX(0), margen);
        ctx.lineTo(aX(0), margen + altoGraf);
        ctx.stroke();

        // Función azul
        ctx.strokeStyle = 'blue';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for(let i = 0; i < xs.length; i++) {
            const xx = aX(xs[i]);
            const yy = ysFunc[i];
            if(yy === null || !isFinite(yy)) {
                ctx.moveTo(xx, aY(0));
            } else {
                const yPos = aY(yy);
                if(i === 0) ctx.moveTo(xx, yPos);
                else ctx.lineTo(xx, yPos);
            }
        }
        ctx.stroke();

        // Derivada roja
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for(let i = 0; i < xs.length; i++) {
            const xx = aX(xs[i]);
            const yy = ysDer[i];
            if(yy === null || !isFinite(yy)) {
                ctx.moveTo(xx, aY(0));
            } else {
                const yPos = aY(yy);
                if(i === 0) ctx.moveTo(xx, yPos);
                else ctx.lineTo(xx, yPos);
            }
        }
        ctx.stroke();

        // Leyenda
        ctx.fillStyle = 'blue';
        ctx.fillRect(margen + 10, margen + 10, 20, 10);
        ctx.fillStyle = 'black';
        ctx.fillText('f(x)', margen + 35, margen + 20);

        ctx.fillStyle = 'red';
        ctx.fillRect(margen + 10, margen + 30, 20, 10);
        ctx.fillStyle = 'black';
        ctx.fillText("f'(x)", margen + 35, margen + 40);

        // Textos ejes
        ctx.font = '12px Arial';
        ctx.fillStyle = 'black';
        ctx.fillText('0', aX(0) - 10, aY(0) + 15);
        ctx.fillText(xMin, margen, aY(0) + 15);
        ctx.fillText(xMax, margen + anchoGraf - 20, aY(0) + 15);
        ctx.fillText(yMin.toFixed(2), aX(0) + 5, margen + altoGraf);
        ctx.fillText(yMax.toFixed(2), aX(0) + 5, margen + 12);
    }
</script>

</body>
</html>
