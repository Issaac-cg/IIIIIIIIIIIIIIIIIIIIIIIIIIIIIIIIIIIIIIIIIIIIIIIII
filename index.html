<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calculadora de Derivadas</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.9.0/math.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-group {
            margin-bottom: 15px;
        }
        input[type="text"] {
            width: 70%;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #grafico {
            margin-top: 20px;
            height: 400px;
        }
        .resultado {
            background-color: #f8f9fa;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Calculadora de Derivadas</h2>
        <div class="input-group">
            <input type="text" id="funcion" placeholder="Ingresa la función (ej: x^2, sin(x))">
            <button onclick="calcularDerivada()">Calcular</button>
            <button onclick="limpiarPantalla()">Limpiar</button>
        </div>
        
        <h3>Resultado Simple:</h3>
        <div class="resultado" id="resultadoSimple"></div>
        
        <h3>Explicación Detallada:</h3>
        <div class="resultado" id="explicacionLarga"></div>
        
        <h3>Gráfico de la Función y su Derivada:</h3>
        <div id="grafico"></div>
    </div>

    <script>
    function cleanExpr(expr) {
        return expr.replace(/ /g, '')
            .replace(/sen/g, 'sin')
            .replace(/(\d+)([a-zA-Z])/g, '$1*$2')
            .replace(/([a-zA-Z])(\d+)/g, '$1*$2')
            .replace(/([a-zA-Z])(\()/g, '$1*$2');
    }

    function derivarFuncion(funcion) {
        try {
            const expr = math.parse(cleanExpr(funcion));
            const derivada = math.derivative(expr, 'x');
            return math.simplify(derivada).toString();
        } catch (e) {
            return "Error en la función ingresada";
        }
    }

    function crearExplicacionCorta(funcion) {
        const derivada = derivarFuncion(funcion);
        return `Método directo:\nf'(x) = ${derivada}`;
    }

    function crearExplicacionLarga(funcion) {
        let pasos = "";
        const expr = cleanExpr(funcion);
        
        try {
            // Paso 1: Definición formal
            pasos += `Paso 1 – Definición formal:\n`;
            pasos += `f'(x) = limₕ→₀ [f(x+h) - f(x)] / h\n`;
            pasos += `Sustituyendo f(x) = ${funcion}:\n`;
            pasos += `f'(x) = limₕ→₀ [${funcion.replace(/x/g, '(x+h)')} - ${funcion}] / h\n\n`;

            // Desarrollo algebraico
            const f_x = math.parse(expr);
            const f_xh = f_x.transform(node => {
                if (node.isSymbolNode && node.name === 'x') {
                    return math.parse('(x + h)');
                }
                return node;
            });
            
            const numerador = math.simplify(math.subtract(f_xh, f_x));
            const paso2 = math.simplify(numerador).toString().replace(/\*\*/g, '^');
            
            // Paso 2: Desarrollo del binomio
            pasos += `Paso 2 – Desarrollo del binomio:\n`;
            pasos += `${funcion.replace(/x/g, '(x+h)')} = ${paso2}\n\n`;
            
            // Paso 3: Cancelar términos
            const paso3 = math.simplify(math.divide(numerador, 'h')).toString().replace(/\*\*/g, '^');
            pasos += `Paso 3 – Cancelar términos:\n`;
            pasos += `= limₕ→₀ (${paso3})\n\n`;

            // Paso 4: Simplificar
            const paso4 = math.simplify(paso3.replace(/\/h/g, '')).toString().replace(/\*\*/g, '^');
            pasos += `Paso 4 – Simplificar:\n`;
            pasos += `= limₕ→₀ (${paso4})\n\n`;

            // Paso 5: Aplicar límite
            const limite = math.simplify(paso4.replace(/h/g, '0')).toString();
            pasos += `Paso 5 – Aplicar el límite:\n`;
            pasos += `= ${limite}\n\n`;

            pasos += `Resultado final:\nf'(x) = ${limite}`;

        } catch (e) {
            pasos = "No se pudo generar explicación detallada para esta función";
        }
        return pasos;
    }

    function graficarFuncion(funcion) {
        try {
            const xValues = Array.from({length: 100}, (_, i) => (i - 50) * 0.1);
            const yOriginal = xValues.map(x => math.evaluate(funcion, {x}));
            const derivada = derivarFuncion(funcion);
            const yDerivada = xValues.map(x => math.evaluate(derivada, {x}));

            const trace1 = {
                x: xValues,
                y: yOriginal,
                mode: 'lines',
                name: 'Función original'
            };

            const trace2 = {
                x: xValues,
                y: yDerivada,
                mode: 'lines',
                name: 'Derivada'
            };

            Plotly.newPlot('grafico', [trace1, trace2], {
                title: 'Función y su Derivada',
                margin: {t: 30}
            });
        } catch (e) {
            document.getElementById('grafico').innerHTML = "Error al generar el gráfico";
        }
    }

    function calcularDerivada() {
        const funcion = document.getElementById('funcion').value;
        document.getElementById('resultadoSimple').textContent = crearExplicacionCorta(funcion);
        document.getElementById('explicacionLarga').textContent = crearExplicacionLarga(funcion);
        graficarFuncion(funcion);
    }

    function limpiarPantalla() {
        document.getElementById('funcion').value = '';
        document.getElementById('resultadoSimple').textContent = '';
        document.getElementById('explicacionLarga').textContent = '';
        Plotly.purge('grafico');
    }
    </script>
</body>
</html>
